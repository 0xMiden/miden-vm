# cargo-deny configuration for Miden VM workspace

# Graph configuration
[graph]
targets = [
    "x86_64-unknown-linux-gnu",
    "x86_64-apple-darwin",
    "aarch64-apple-darwin",
    "x86_64-pc-windows-msvc",
]

# Advisory database configuration
[advisories]
db-path = "~/.cargo/advisory-db"
db-urls = ["https://github.com/rustsec/advisory-db"]
yanked = "warn"
ignore = [
    "RUSTSEC-2024-0436", # paste is unmaintained but no alternative available
]

# License configuration
[licenses]
allow = [
    "MIT",
    "Apache-2.0",
    "Apache-2.0 WITH LLVM-exception",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "CC0-1.0",
    "ISC",
    "Zlib",
    "Unicode-3.0",
]
exceptions = [
    # Each entry is the crate and version constraint, and its specific allowed licenses
    #{ allow = ["Zlib"], name = "adler32", version = "*" },
]

# Bans configuration
[bans]
multiple-versions = "deny"
wildcards = "allow"
highlight = "all"
allow = [
    #{ name = "ansi_term", version = "=0.11.0" },
]
deny = [
    #{ name = "ansi_term", version = "=0.11.0" },
]
skip = [
    #{ name = "ansi_term", version = "=0.11.0" },
]
skip-tree = [
    # Allow getrandom v0.2.x for now - will be phased out with nanorand
    { name = "getrandom", version = "=0.2.16" },
    # Allow rand_core v0.6.x for now - legacy dependency
    { name = "rand_core", version = "=0.6.4" },
    # Allow rustc_version v0.2.x - build dependency
    { name = "rustc_version", version = "=0.2.3" },
    # Allow windows-targets v0.48.x - older Windows target
    { name = "windows-targets", version = "=0.48.5" },
    # Allow unicode-width v0.1.x - miden-miette vs miden-formatting conflict (complex to fix)
    { name = "unicode-width", version = "=0.1.14" },
    # Allow windows-sys v0.48.x/v0.59.x - multiple Windows system libraries (hard to converge)
    { name = "windows-sys", version = "=0.48.0" },
    { name = "windows-sys", version = "=0.59.0" },
    # Allow syn v1.x and v2.x - our derive macros need v1.x while ecosystem uses v2.x
    { name = "syn", version = "=1.0.109" },
    { name = "syn", version = "=2.0.111" },
    # TODO(plonky3): Allow itertools 0.12.x/0.13.x - miden-verifier uses older version
    # Update miden-verifier to 0.14.x once Plonky3 migration stabilizes
    { name = "itertools", version = "=0.12.1" },
    { name = "itertools", version = "=0.13.0" },
    # TODO(plonky3): Allow duplicate miden crates during migration
    # miden-air v0.3.0 from Plonky3 fork vs local v0.20.0
    { name = "miden-air", version = "=0.3.0" },
    # miden-crypto v0.14.1 from crates.io (old) vs v0.20.0 from migration branch
    { name = "miden-crypto", version = "=0.14.1" },
    # miden-prover v0.3.0 from Plonky3 fork vs local v0.20.0
    { name = "miden-prover", version = "=0.3.0" },
    # spin v0.9.x via flume/miden-crypto vs v0.10.x via p3-dft
    { name = "spin", version = "=0.9.8" },
]

# Sources configuration
[sources]
unknown-registry = "deny"
unknown-git = "deny"
allow-registry = ["https://github.com/rust-lang/crates.io-index"]
# TODO(plonky3): Remove git sources once Plonky3 and miden-crypto are published to crates.io
# During migration, we depend on development branches for Plonky3 integration
allow-git = [
    "https://github.com/0xMiden/Plonky3",
    "https://github.com/0xMiden/crypto",
]
