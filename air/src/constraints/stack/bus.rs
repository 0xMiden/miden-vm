use miden_core::field::PrimeCharacteristicRing;
use miden_crypto::stark::air::MidenAirBuilder;

use crate::MainTraceRow;

pub fn enforce_stack_bus_constraints<AB>(builder: &mut AB, alpha: AB::RandomVar, beta_challenges: &[AB::RandomVar], aux_current: &[AB::VarEF], aux_next: &[AB::VarEF], local: &MainTraceRow<AB::Var>, next: &MainTraceRow<AB::Var>, periodic_values: &[AB::PeriodicVal])
where
    AB: MidenAirBuilder,
{
    enforce_stack_overflow_bus_constraints(builder, alpha, &beta_challenges, &aux_current, &aux_next, local, next, periodic_values);
}

pub fn enforce_stack_overflow_bus_constraints<AB>(
    builder: &mut AB,
    alpha: AB::RandomVar,
    beta_challenges: &[AB::RandomVar],
    aux_current: &[AB::VarEF],
    aux_next: &[AB::VarEF],
    local: &MainTraceRow<AB::Var>,
    next: &MainTraceRow<AB::Var>,
    periodic_values: &[AB::PeriodicVal],
) where
    AB: MidenAirBuilder,
{
    builder.when_transition().assert_zero_ext(((alpha.into() + AB::ExprEF::from(local.clk.clone().into()) * beta_challenges[0].into() + AB::ExprEF::from(local.stack[15].clone().into()) * beta_challenges[1].into() + AB::ExprEF::from(local.stack[17].clone().into()) * beta_challenges[2].into()) * ((AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[7].clone().into())) * AB::ExprEF::from(local.decoder[6].clone().into()) * AB::ExprEF::from(local.decoder[5].clone().into()) + AB::ExprEF::from(local.decoder[7].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[6].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into())) * AB::ExprEF::from(local.decoder[4].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[3].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[1].clone().into())) + AB::ExprEF::from(local.decoder[22].clone().into()) * AB::ExprEF::from(local.decoder[4].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[3].clone().into())) * AB::ExprEF::from(local.decoder[2].clone().into()) * AB::ExprEF::from(local.decoder[1].clone().into())) + AB::ExprEF::ONE - ((AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[7].clone().into())) * AB::ExprEF::from(local.decoder[6].clone().into()) * AB::ExprEF::from(local.decoder[5].clone().into()) + AB::ExprEF::from(local.decoder[7].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[6].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into())) * AB::ExprEF::from(local.decoder[4].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[3].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[1].clone().into())) + AB::ExprEF::from(local.decoder[22].clone().into()) * AB::ExprEF::from(local.decoder[4].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[3].clone().into())) * AB::ExprEF::from(local.decoder[2].clone().into()) * AB::ExprEF::from(local.decoder[1].clone().into()))) * AB::ExprEF::from(aux_current[3].clone().into()) - ((alpha.into() + AB::ExprEF::from(local.stack[17].clone().into()) * beta_challenges[0].into() + AB::ExprEF::from(local.stack[15].clone().into()) * beta_challenges[1].into() + AB::ExprEF::from(local.stack[17].clone().into()) * beta_challenges[2].into()) * ((AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[7].clone().into())) * AB::ExprEF::from(local.decoder[6].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into())) + AB::ExprEF::from(local.decoder[7].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[6].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into())) * AB::ExprEF::from(local.decoder[4].clone().into()) * AB::ExprEF::from(local.decoder[3].clone().into()) + AB::ExprEF::from(local.decoder[22].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[4].clone().into())) * AB::ExprEF::from(local.decoder[3].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[1].clone().into())) + AB::ExprEF::from(local.decoder[22].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[4].clone().into())) * AB::ExprEF::from(local.decoder[3].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * AB::ExprEF::from(local.decoder[1].clone().into()) + AB::ExprEF::from(local.decoder[22].clone().into()) * AB::ExprEF::from(local.decoder[4].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[3].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[1].clone().into())) + AB::ExprEF::from(local.decoder[23].clone().into()) * AB::ExprEF::from(local.decoder[5].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[4].clone().into())) * AB::ExprEF::from(local.decoder[3].clone().into()) + AB::ExprEF::from(local.decoder[23].clone().into()) * AB::ExprEF::from(local.decoder[5].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[4].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[3].clone().into())) * AB::ExprEF::from(local.decoder[13].clone().into())) * (AB::ExprEF::from(local.stack[16].clone().into()) - AB::ExprEF::from_u64(16)) * AB::ExprEF::from(local.stack[18].clone().into()) + AB::ExprEF::ONE - ((AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[7].clone().into())) * AB::ExprEF::from(local.decoder[6].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into())) + AB::ExprEF::from(local.decoder[7].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[6].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into())) * AB::ExprEF::from(local.decoder[4].clone().into()) * AB::ExprEF::from(local.decoder[3].clone().into()) + AB::ExprEF::from(local.decoder[22].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[4].clone().into())) * AB::ExprEF::from(local.decoder[3].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[1].clone().into())) + AB::ExprEF::from(local.decoder[22].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[4].clone().into())) * AB::ExprEF::from(local.decoder[3].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * AB::ExprEF::from(local.decoder[1].clone().into()) + AB::ExprEF::from(local.decoder[22].clone().into()) * AB::ExprEF::from(local.decoder[4].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[3].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[1].clone().into())) + AB::ExprEF::from(local.decoder[23].clone().into()) * AB::ExprEF::from(local.decoder[5].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[4].clone().into())) * AB::ExprEF::from(local.decoder[3].clone().into()) + AB::ExprEF::from(local.decoder[23].clone().into()) * AB::ExprEF::from(local.decoder[5].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[4].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[3].clone().into())) * AB::ExprEF::from(local.decoder[13].clone().into())) * (AB::ExprEF::from(local.stack[16].clone().into()) - AB::ExprEF::from_u64(16)) * AB::ExprEF::from(local.stack[18].clone().into())) * ((alpha.into() + AB::ExprEF::from(local.stack[17].clone().into()) * beta_challenges[0].into() + AB::ExprEF::from(local.stack[15].clone().into()) * beta_challenges[1].into() + AB::ExprEF::from(local.decoder[13].clone().into()) * beta_challenges[2].into()) * AB::ExprEF::from(local.decoder[22].clone().into()) * AB::ExprEF::from(local.decoder[4].clone().into()) * AB::ExprEF::from(local.decoder[3].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[1].clone().into())) * (AB::ExprEF::from(local.stack[16].clone().into()) - AB::ExprEF::from_u64(16)) * AB::ExprEF::from(local.stack[18].clone().into()) + AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[22].clone().into()) * AB::ExprEF::from(local.decoder[4].clone().into()) * AB::ExprEF::from(local.decoder[3].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[2].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[1].clone().into())) * (AB::ExprEF::from(local.stack[16].clone().into()) - AB::ExprEF::from_u64(16)) * AB::ExprEF::from(local.stack[18].clone().into())) * AB::ExprEF::from(aux_next[3].clone().into()));
}
