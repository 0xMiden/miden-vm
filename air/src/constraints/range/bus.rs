use core::borrow::Borrow;

use miden_core::field::PrimeCharacteristicRing;
use miden_crypto::stark::air::MidenAirBuilder;

use crate::MainTraceRow;

/// Enforces the range checker bus constraint for LogUp multiset checks.
///
/// This constraint tracks range check requests from other components (stack and memory)
/// using the LogUp protocol. The bus accumulator b_range must start and end at 0,
/// and transitions according to the LogUp update rule.
///
/// This is a degree-9 constraint.
pub fn enforce_range_bus_constraints<AB>(builder: &mut AB, alpha: AB::RandomVar, beta_challenges: &[AB::RandomVar], aux_current: &[AB::VarEF], aux_next: &[AB::VarEF], local: &MainTraceRow<AB::Var>, next: &MainTraceRow<AB::Var>)
where
    AB: MidenAirBuilder,
{
    builder.when_transition().assert_zero_ext((alpha.into() + AB::ExprEF::from(local.range[1].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[14].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[15].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[10].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[11].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[12].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[13].clone().into()) * beta_challenges[0].into()) * AB::ExprEF::from(aux_current[4].clone().into()) + (alpha.into() + AB::ExprEF::from(local.chiplets[14].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[15].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[10].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[11].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[12].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[13].clone().into()) * beta_challenges[0].into()) * AB::ExprEF::from(local.range[0].clone().into()) - ((alpha.into() + AB::ExprEF::from(local.range[1].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[14].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[15].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[10].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[11].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[12].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[13].clone().into()) * beta_challenges[0].into()) * AB::ExprEF::from(aux_next[4].clone().into()) + (alpha.into() + AB::ExprEF::from(local.range[1].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[15].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[10].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[11].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[12].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[13].clone().into()) * beta_challenges[0].into()) * AB::ExprEF::from(local.chiplets[0].clone().into()) * AB::ExprEF::from(local.chiplets[1].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.chiplets[2].clone().into())) + (alpha.into() + AB::ExprEF::from(local.range[1].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[14].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[10].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[11].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[12].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[13].clone().into()) * beta_challenges[0].into()) * AB::ExprEF::from(local.chiplets[0].clone().into()) * AB::ExprEF::from(local.chiplets[1].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.chiplets[2].clone().into())) + (alpha.into() + AB::ExprEF::from(local.range[1].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[14].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[15].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[11].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[12].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[13].clone().into()) * beta_challenges[0].into()) * AB::ExprEF::from(local.decoder[7].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[6].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into())) + (alpha.into() + AB::ExprEF::from(local.range[1].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[14].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[15].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[10].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[12].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[13].clone().into()) * beta_challenges[0].into()) * AB::ExprEF::from(local.decoder[7].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[6].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into())) + (alpha.into() + AB::ExprEF::from(local.range[1].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[14].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[15].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[10].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[11].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[13].clone().into()) * beta_challenges[0].into()) * AB::ExprEF::from(local.decoder[7].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[6].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into())) + (alpha.into() + AB::ExprEF::from(local.range[1].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[14].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.chiplets[15].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[10].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[11].clone().into()) * beta_challenges[0].into()) * (alpha.into() + AB::ExprEF::from(local.decoder[12].clone().into()) * beta_challenges[0].into()) * AB::ExprEF::from(local.decoder[7].clone().into()) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[6].clone().into())) * (AB::ExprEF::ONE - AB::ExprEF::from(local.decoder[5].clone().into()))));
}
